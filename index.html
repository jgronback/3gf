
<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3GF – Tävling</title>
  <style>
    :root{ --bg:#0e1117; --panel:#151a23; --panel2:#10141d; --border:#283043; --ink:#e7ebf4; --muted:#a5b0c4; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:12px; }
    h1{ font-size:1.2rem; margin:0 0 10px; }
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tab{ padding:10px 14px; background:var(--panel); border:1px solid var(--border); border-radius:10px; cursor:pointer; }
    .tab.active{ outline:2px solid #3b82f6; }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; }
    label{ display:block; margin:8px 0 4px; color:var(--muted); }
    input, select, button, textarea{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--panel2); color:var(--ink); }
    button{ cursor:pointer; font-weight:600; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row>div{ flex:1; min-width:180px; }
    .grid{ display:grid; gap:10px; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); }
    .people{ display:grid; gap:8px; }
    .person{ padding:10px; border:1px dashed var(--border); border-radius:10px; }
    .boards{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--panel2); }
    .right{ text-align:right; }
  </style>
</head>
<body>
  <h1>3GF – Tävling</h1>
  <div class="tabs" id="tabs"></div>

  <div id="view"></div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const SKEY = id => `3gf_state_${id||'local'}`;

  // App-state (DB-agnostiskt)
  let s = {
    tab: 'Start',
    eventId: 'satila-local',
    settings: { name:'', date:'', place:'', penP:5, penH:5, penG:5, boards:3 },
    people: [],
    activeIndex: 0
  };

  // Tabs
  const ALL_TABS = ['Start','Tävling','Varv','Resultat'];
  function renderTabs(){
    const el = document.getElementById('tabs');
    el.innerHTML = '';
    ALL_TABS.forEach(t => {
      const b = document.createElement('button');
      b.className = 'tab'+(s.tab===t?' active':'');
      b.textContent = t;
      b.onclick = () => { s.tab=t; render(); };
      el.appendChild(b);
    });
  }

  // Persistens (localStorage)
  function persist(){ localStorage.setItem(SKEY(s.eventId), JSON.stringify(s)); }
  function load(id){
    const raw = localStorage.getItem(SKEY(id));
    if (raw) {
      try { s = JSON.parse(raw); }
      catch(_){}
    }
    s.eventId = id;
  }

  // Helpers
  function addPerson(){
    s.people.push({ id:crypto.randomUUID(), name:'', club:'', klass:'', laps:[] });
  }

  function saveSettingsFromDom(root){
    s.settings.name = qs('#name',root).value.trim();
    s.settings.date = qs('#date',root).value.trim();
    s.settings.place = qs('#place',root).value.trim();
    s.settings.penP = +qs('#penP',root).value || 5;
    s.settings.penH = +qs('#penH',root).value || 5;
    s.settings.penG = +qs('#penG',root).value || 5;
    s.settings.boards = Math.max(1, Math.min(12, +qs('#boards',root).value||3));
  }

  function renderStart(){
    const wrap = document.createElement('div');
    wrap.className = 'panel';
    wrap.innerHTML = `
      <div class="row">
        <div><label>Tävlingens namn</label><input id="name" placeholder="3GF Cup" value="${s.settings.name||''}"></div>
        <div><label>Datum</label><input id="date" type="date" value="${s.settings.date||''}"></div>
        <div><label>Plats</label><input id="place" placeholder="Sätila" value="${s.settings.place||''}"></div>
      </div>
      <div class="row">
        <div><label>Straff pistol (s/miss)</label><input id="penP" type="number" step="0.01" value="${s.settings.penP}"></div>
        <div><label>Straff hagel (s/miss)</label><input id="penH" type="number" step="0.01" value="${s.settings.penH}"></div>
        <div><label>Straff gevär (s/miss)</label><input id="penG" type="number" step="0.01" value="${s.settings.penG}"></div>
      </div>
      <div class="row">
        <div><label>Antal poängtavlor</label><input id="boards" type="number" min="1" max="12" value="${s.settings.boards}"></div>
        <div class="right"><label>&nbsp;</label><button id="startBtn">Starta tävling</button></div>
      </div>
    `;
    wrap.querySelector('#startBtn').onclick = () => {
      saveSettingsFromDom(wrap);
      persist();
      s.tab = 'Tävling';
      render();
    };
    return wrap;
  }

  function renderCompetition(){
    const wrap = document.createElement('div');
    wrap.className = 'panel';

    // Överdel: Poängtavlorna
    const boards = Array.from({length: s.settings.boards}, (_,i)=>`<span class="chip">Poängtavla ${i+1}</span>`).join(' ');

    // Personlista
    const list = document.createElement('div');
    list.className = 'people';
    s.people.forEach((p,idx)=>{
      const card = document.createElement('div');
      card.className = 'person';
      card.innerHTML = `
        <div class="row">
          <div><label>Namn</label><input data-f="name" value="${p.name||''}"></div>
          <div><label>Klubb</label><input data-f="club" value="${p.club||''}"></div>
          <div><label>Klass</label><input data-f="klass" value="${p.klass||''}"></div>
          <div class="right"><label>&nbsp;</label>
            <button data-act="lap">Lägg till varv</button>
            <button data-act="del">Ta bort</button>
          </div>
        </div>
      `;
      qsa('input', card).forEach(inp=>{
        inp.oninput = () => {
          const f = inp.getAttribute('data-f');
          p[f] = inp.value;
          persist();
        };
      });
      qsa('button', card).forEach(btn=>{
        const act = btn.getAttribute('data-act');
        btn.onclick = () => {
          if (act==='del') { s.people.splice(idx,1); if(s.activeIndex>=s.people.length) s.activeIndex=0; persist(); render(); }
          if (act==='lap') { s.activeIndex = idx; s.tab='Varv'; render(); }
        };
      });
      list.appendChild(card);
    });

    wrap.innerHTML = `<div class="boards">${boards}</div>`;

    const addRow = document.createElement('div');
    addRow.className = 'row';
    const addBtn = document.createElement('button');
    addBtn.textContent = 'Lägg till deltagare';
    addBtn.onclick = ()=>{ addPerson(); persist(); render(); };
    addRow.appendChild(addBtn);

    wrap.appendChild(document.createElement('hr'));
    wrap.appendChild(list);
    wrap.appendChild(addRow);

    return wrap;
  }

  function renderLap(){
    if (!s.people.length) { s.tab='Tävling'; return render(); }
    const p = s.people[s.activeIndex] || s.people[0];

    const wrap = document.createElement('div');
    wrap.className = 'panel';
    wrap.innerHTML = `
      <div class="row">
        <div><label>Deltagare</label><input value="${p.name||''}" disabled></div>
        <div><label>PT (poängtid)</label><input id="ptLap" type="number" step="0.01" value=""></div>
      </div>
      <div class="row">
        <div><label>Pistol tid</label><input id="tP" type="number" step="0.01" value=""></div>
        <div><label>Pistol miss</label><input id="mP" type="number" min="0" step="1" value=""></div>
        <div><label>Hagel tid</label><input id="tH" type="number" step="0.01" value=""></div>
        <div><label>Hagel miss</label><input id="mH" type="number" min="0" step="1" value=""></div>
        <div><label>Gevär tid</label><input id="tG" type="number" step="0.01" value=""></div>
        <div><label>Gevär miss</label><input id="mG" type="number" min="0" step="1" value=""></div>
      </div>
      <div class="row">
        <div class="right"><label>&nbsp;</label><button id="saveLap">Spara varv</button></div>
      </div>
    `;

    wrap.querySelector('#saveLap').onclick = () => {
      const v = {
        tP:+$('#tP').value||0, mP:+$('#mP').value||0,
        tH:+$('#tH').value||0, mH:+$('#mH').value||0,
        tG:+$('#tG').value||0, mG:+$('#mG').value||0,
        pt:+$('#ptLap').value||0,
        dtH: Date.now()
      };
      p.laps.push(v);
      // Rensa inputs
      ;['tP','mP','tH','mH','tG','mG','ptLap'].forEach(id=>$(id).value='');
      // Hoppa till nästa deltagare
      if (s.people.length>1) s.activeIndex = (s.activeIndex+1)%s.people.length;
      persist();
      s.tab = 'Tävling';
      render();
    };

    return wrap;
  }

  function renderResult(){
    const wrap = document.createElement('div');
    wrap.className = 'panel';

    // Enkel summering
    const rows = s.people.map(p=>{
      const penP = s.settings.penP, penH=s.settings.penH, penG=s.settings.penG;
      let time=0, misses=0, laps=0;
      p.laps.forEach(v=>{
        time += (v.tP||0)+(v.tH||0)+(v.tG||0)+(v.pt||0);
        misses += (v.mP||0)+(v.mH||0)+(v.mG||0);
        laps += 1;
      });
      const penalty = (p.laps||[]).reduce((acc,v)=>acc + (v.mP||0)*penP + (v.mH||0)*penH + (v.mG||0)*penG, 0);
      const total = time + penalty;
      return { name:p.name||'', club:p.club||'', klass:p.klass||'', laps, total };
    });

    rows.sort((a,b)=> a.total - b.total);

    const tbl = document.createElement('table');
    tbl.style.width='100%';
    tbl.innerHTML = `
      <thead><tr><th style="text-align:left">Namn</th><th style="text-align:left">Klubb</th><th style="text-align:left">Klass</th><th>Varv</th><th>Total (s)</th></tr></thead>
      <tbody></tbody>
    `;
    const tbody = tbl.querySelector('tbody');
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.name}</td><td>${r.club}</td><td>${r.klass}</td><td style="text-align:center">${r.laps}</td><td style="text-align:right">${r.total.toFixed(2)}</td>`;
      tbody.appendChild(tr);
    });

    wrap.appendChild(tbl);
    return wrap;
  }

  function render(){
    renderTabs();
    const v = document.getElementById('view');
    v.innerHTML = '';
    if (s.tab==='Start') v.appendChild(renderStart());
    if (s.tab==='Tävling') v.appendChild(renderCompetition());
    if (s.tab==='Varv') v.appendChild(renderLap());
    if (s.tab==='Resultat') v.appendChild(renderResult());
  }

  // Init
  load('satila-local');
  render();
})();
</script>
</body>
</html>




