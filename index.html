<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3GF – Tävling</title>
  <style>
    :root{ --bg:#0e1117; --panel:#151a23; --panel2:#10141d; --border:#283043; --ink:#e7ebf4; --muted:#a5b0c4; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:12px; }
    h1{ font-size:1.2rem; margin:0 0 10px; }
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tab{ padding:10px 14px; background:var(--panel); border:1px solid var(--border); border-radius:10px; cursor:pointer; }
    .tab.active{ outline:2px solid #3b82f6; }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; }
    label{ display:block; margin:8px 0 4px; color:var(--muted); }
    input, select, button{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--panel2); color:var(--ink); }
    button{ cursor:pointer; font-weight:600; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row>div{ flex:1; min-width:160px; }
    .right{ text-align:right; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th, td{ border-bottom:1px solid #283043; padding:8px; text-align:left; }
    .num{ text-align:right; }
    /* Tävlingsform: tid stor, miss halvbred */
    .pair{ display:flex; gap:10px; }
    .time{ flex:2; }
    .miss{ flex:1; }
    .active-badge{ font-weight:600; background:#1e2a44; padding:6px 10px; border-radius:8px; margin:6px 0 10px; display:inline-block; }
    .controls{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0; }
  </style>
</head>
<body>
  <h1>3GF – Tävling</h1>
  <div class="tabs" id="tabs"></div>
  <div id="view"></div>

<script>
(function(){
  // Helpers
  const $  = (id, el=document) => el.getElementById(id);
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa= (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const KEY = "3gf_state";                  // Admin läser samma nyckel
  const uid = () => (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));

  // ---- State ----
  let s = {
    tab: 'Start',
    settings: { name:'', date:'', place:'', penP:5, penH:5, penG:5, boards:3 },
    people: [],
    activeId: null
  };

  // Persist
  const save = ()=> localStorage.setItem(KEY, JSON.stringify(s));
  const load = ()=>{
    const raw = localStorage.getItem(KEY);
    if (raw) { try { s = JSON.parse(raw); } catch(e){} }
    // migration: id + activeId
    (s.people||=[]).forEach(p=>{ if(!p.id) p.id=uid(); if(!Array.isArray(p.laps)) p.laps=[]; });
    if (!s.activeId && s.people.length) s.activeId = s.people[0].id;
    // Start ska alltid vara först när man öppnar
    s.tab = 'Start';
  };

  // Tabs
  const TABS = ['Start','Tävling'];
  function renderTabs(){
    const el = $('tabs'); el.innerHTML='';
    TABS.forEach(t=>{
      const b = document.createElement('button');
      b.className = 'tab' + (s.tab===t?' active':'');
      b.textContent = t;
      b.onclick = ()=>{ s.tab=t; render(); };
      el.appendChild(b);
    });
  }

  // Helpers
  const getP = id => s.people.find(p=>p.id===id)||null;
  const label = (p, i) => (p.name?.trim() ? `${p.name}${p.klass?.trim()?` (${p.klass})`:''}` : `Deltagare ${i+1}`);

  function addPersonFromInputs(wrap){
    const name = qs('#name',wrap).value.trim();
    const club = qs('#club',wrap).value.trim();
    const klass= qs('#klass',wrap).value.trim();
    const p = { id: uid(), name, club, klass, laps:[] };
    s.people = [...s.people, p];
    s.activeId = p.id;
    save(); render();
  }
  function removeActive(){
    if (!s.activeId) return;
    const i = s.people.findIndex(x=>x.id===s.activeId);
    s.people = s.people.filter(p=>p.id!==s.activeId);
    s.activeId = s.people.length ? s.people[Math.min(i, s.people.length-1)].id : null;
    save(); render();
  }

  // Start
  function viewStart(){
    const w = document.createElement('div'); w.className='panel';
    w.innerHTML = `
      <div class="row">
        <div><label>Tävlingens namn (valfritt)</label><input id="evName" value="${s.settings.name||''}"></div>
        <div><label>Datum (valfritt)</label><input id="evDate" type="date" value="${s.settings.date||''}"></div>
        <div><label>Plats (valfritt)</label><input id="evPlace" value="${s.settings.place||''}"></div>
      </div>
      <div class="row">
        <div><label>Straff Pistol (s/miss)</label><input id="penP" type="number" step="0.01" value="${s.settings.penP}"></div>
        <div><label>Straff Hagel (s/miss)</label><input id="penH" type="number" step="0.01" value="${s.settings.penH}"></div>
        <div><label>Straff Karbin (s/miss)</label><input id="penG" type="number" step="0.01" value="${s.settings.penG}"></div>
      </div>
      <div class="row">
        <div><label>Antal poängtavlor</label><input id="boards" type="number" min="1" max="12" value="${s.settings.boards}"></div>
        <div class="right"><label>&nbsp;</label><button id="startBtn">Starta tävling</button></div>
      </div>
    `;
    qs('#startBtn',w).onclick = ()=>{
      s.settings.name  = qs('#evName',w).value.trim();
      s.settings.date  = qs('#evDate',w).value.trim();
      s.settings.place = qs('#evPlace',w).value.trim();
      s.settings.penP  = +qs('#penP',w).value||0;
      s.settings.penH  = +qs('#penH',w).value||0;
      s.settings.penG  = +qs('#penG',w).value||0;
      s.settings.boards= Math.max(1, Math.min(12, +qs('#boards',w).value||1));
      s.tab='Tävling'; save(); render();
    };
    return w;
  }

  // Resultat-beräkning
  function summarize(){
    const {penP,penH,penG} = s.settings;
    return s.people.map((p,i)=>{
      let base=0, miss=0, laps=0;
      (p.laps||[]).forEach(v=>{
        base += (v.tP||0)+(v.tH||0)+(v.tG||0)+(v.pt||0);
        miss += (v.mP||0)*penP + (v.mH||0)*penH + (v.mG||0)*penG;
        laps++;
      });
      return { name: label(p,i), club:p.club||'', klass:p.klass||'', laps, total: base+miss };
    }).sort((a,b)=>a.total-b.total);
  }

  // Tävlingsvy (v7.7-flöde)
  function viewRace(){
    const root = document.createElement('div'); root.className='panel';

    // Lägg till deltagare
    const add = document.createElement('div'); add.className='panel';
    add.innerHTML = `
      <h3 style="margin:0 0 8px">Lägg till deltagare</h3>
      <div class="row">
        <div><label>Namn</label><input id="name" /></div>
        <div><label>Klubb</label><input id="club" /></div>
        <div><label>Klass</label><input id="klass" /></div>
      </div>
      <div class="controls">
        <button id="addParticipant">Lägg till</button>
      </div>
    `;
    qs('#addParticipant',add).onclick = ()=> addPersonFromInputs(add);
    root.appendChild(add);

    // Aktiv deltagare + varvformulär
    const pane = document.createElement('div'); pane.className='panel';
    pane.innerHTML = `
      <label>Aktiv deltagare</label>
      <select id="activeSel"></select>
      <div id="activeBadge" class="active-badge">Ingen vald</div>

      <div class="row">
        <div class="time"><div><label>Pistol tid</label><input id="tP" type="number" step="0.01"></div></div>
        <div class="miss"><div><label>Miss P</label><input id="mP" type="number" min="0" step="1"></div></div>
      </div>
      <div class="row">
        <div class="time"><div><label>Hagel tid</label><input id="tH" type="number" step="0.01"></div></div>
        <div class="miss"><div><label>Miss H</label><input id="mH" type="number" min="0" step="1"></div></div>
      </div>
      <div class="row">
        <div class="time"><div><label>Karbin tid</label><input id="tG" type="number" step="0.01"></div></div>
        <div class="miss"><div><label>Miss K</label><input id="mG" type="number" min="0" step="1"></div></div>
      </div>
      <div class="row">
        <div><label>PT detta varv</label><input id="ptLap" type="number" step="0.01"></div>
      </div>

      <div class="controls">
        <button id="saveLap">Spara varv</button>
        <button id="removeActive">Ta bort vald</button>
      </div>
    `;
    root.appendChild(pane);

    // Fyll select
    const sel = qs('#activeSel',pane);
    sel.innerHTML='';
    s.people.forEach((p,i)=>{
      const o=document.createElement('option');
      o.value=p.id; o.textContent=label(p,i);
      sel.appendChild(o);
    });
    if (s.activeId && s.people.find(p=>p.id===s.activeId)) sel.value=s.activeId;

    const badge = qs('#activeBadge',pane);
    const setBadge=()=>{
      const p=getP(sel.value);
      badge.textContent = p ? (p.name || label(p, s.people.findIndex(x=>x.id===p.id))) : 'Ingen vald';
    };
    setBadge();

    sel.onchange=()=>{ s.activeId=sel.value||null; save(); setBadge(); };

    // Handlers
    qs('#removeActive',pane).onclick = removeActive;

    // >>> SPÄRR: kräver minst ett ifyllt värde innan spar <<<
    function hasAnyInput(){
      const vals = [
        +qs('#tP',pane).value || 0,
        +qs('#mP',pane).value || 0,
        +qs('#tH',pane).value || 0,
        +qs('#mH',pane).value || 0,
        +qs('#tG',pane).value || 0,
        +qs('#mG',pane).value || 0,
        +qs('#ptLap',pane).value || 0
      ];
      return vals.some(v => v !== 0);
    }

    qs('#saveLap',pane).onclick = ()=>{
      const p = getP(sel.value);
      if (!p){ alert('Välj deltagare först.'); return; }

      if (!hasAnyInput()){
        alert('Fyll i minst ett värde (tid, miss eller PT) innan du sparar varvet.');
        return;
      }

      const v = {
        tP:+qs('#tP',pane).value||0, mP:+qs('#mP',pane).value||0,
        tH:+qs('#tH',pane).value||0, mH:+qs('#mH',pane).value||0,
        tG:+qs('#tG',pane).value||0, mG:+qs('#mG',pane).value||0,
        pt:+qs('#ptLap',pane).value||0,
        dtH: Date.now()
      };
      p.laps = [...(p.laps||[]), v];

      // nollställ
      ['#tP','#mP','#tH','#mH','#tG','#mG','#ptLap'].forEach(id=>{ const el=qs(id, pane); if(el) el.value=''; });

      // hoppa till nästa
      if (s.people.length>1){
        const i = s.people.findIndex(x=>x.id===p.id);
        const nxt = s.people[(i+1)%s.people.length];
        s.activeId = nxt.id; sel.value = nxt.id; setBadge();
      }
      save(); render(); // uppdatera resultatlistan
    };

    // Resultatlista
    const resultsPanel = document.createElement('div'); resultsPanel.className='panel';
    resultsPanel.innerHTML = `
      <h3 style="margin:0 0 8px">Resultat</h3>
      <div class="controls">
        <button id="exportCSV">Exportera CSV</button>
        <button id="exportHTML">Snygg utskrift / Export</button>
      </div>
      <div id="resultsContainer"></div>
    `;
    root.appendChild(resultsPanel);

    const cont = qs('#resultsContainer',resultsPanel);
    const rows = summarize();
    const tbl = document.createElement('table');
    tbl.innerHTML = `<thead><tr><th>Namn</th><th>Klubb</th><th>Klass</th><th class="num">Varv</th><th class="num">Total (s)</th></tr></thead><tbody></tbody>`;
    const tb = qs('tbody',tbl);
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.name}</td><td>${r.club}</td><td>${r.klass}</td><td class="num">${r.laps}</td><td class="num">${r.total.toFixed(2)}</td>`;
      tb.appendChild(tr);
    });
    cont.innerHTML=''; cont.appendChild(tbl);

    // Export
    qs('#exportCSV',resultsPanel).onclick = ()=>{
      const csv = ['Namn,Klubb,Klass,Varv,Total (s)'].concat(
        rows.map(r=>[r.name,r.club,r.klass,r.laps,r.total.toFixed(2)].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(','))
      ).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='resultat.csv'; a.click();
    };
    qs('#exportHTML',resultsPanel).onclick = ()=>{
      const w=window.open('','print','width=800,height=900');
      const html=`<!doctype html><meta charset="utf-8"><title>Resultat</title>
      <style>body{font-family:system-ui,sans-serif} table{border-collapse:collapse;width:100%} th,td{border:1px solid #ccc;padding:6px;text-align:left} .num{text-align:right}</style>
      <h2>Resultat</h2>${tbl.outerHTML}`;
      w.document.write(html); w.document.close(); w.focus();
    };

    return root;
  }

  // Render
  function render(){
    renderTabs();
    const v=$('view'); v.innerHTML='';
    if (s.tab==='Start') v.appendChild(viewStart());
    if (s.tab==='Tävling') v.appendChild(viewRace());
  }

  // Init
  load(); render();
})();
</script>
</body>
</html>
