<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3GF – Tävling</title>
  <style>
    :root{ --bg:#0e1117; --panel:#151a23; --panel2:#10141d; --border:#283043; --ink:#e7ebf4; --muted:#a5b0c4; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:12px; }
    h1{ font-size:1.2rem; margin:0 0 10px; }
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tab{ padding:10px 14px; background:var(--panel); border:1px solid var(--border); border-radius:10px; cursor:pointer; }
    .tab.active{ outline:2px solid #3b82f6; }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; }
    label{ display:block; margin:8px 0 4px; color:var(--muted); }
    input, select, button, textarea{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--panel2); color:var(--ink); }
    button{ cursor:pointer; font-weight:600; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row>div{ flex:1; min-width:200px; }
    .right{ text-align:right; }
    .boards{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:8px; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--panel2); }
    .people{ display:grid; gap:8px; }
    .person{ padding:10px; border:1px dashed var(--border); border-radius:10px; }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th, td{ border-bottom:1px solid #283043; padding:8px; text-align:left; }
    .num{ text-align:right; }
  </style>
</head>
<body>
  <h1>3GF – Tävling</h1>
  <div class="tabs" id="tabs"></div>
  <div id="view"></div>

<script>
(function(){
  const $ = (id, el=document) => el.getElementById ? el.getElementById(id) : document.getElementById(id);
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const SKEY = id => `3gf_state_${id||'local'}`;

  // ---- App state (ingen DB här) ----
  let s = {
    tab: 'Start',
    eventId: 'satila-local',
    settings: { name:'', date:'', place:'', penP:5, penH:5, penG:5, boards:3 },
    people: [],
    activeIndex: 0
  };

  // ---- Persist ----
  function persist(){ localStorage.setItem(SKEY(s.eventId), JSON.stringify(s)); }
  function load(id){
    const raw = localStorage.getItem(SKEY(id));
    if (raw) {
      try { s = JSON.parse(raw); }
      catch(_) {}
    } else {
      s.eventId = id;
    }
  }

  // ---- Tabs ----
  const TABS = ['Start','Tävling'];
  function renderTabs(){
    const el = document.getElementById('tabs');
    el.innerHTML = '';
    TABS.forEach(t=>{
      const b = document.createElement('button');
      b.className = 'tab' + (s.tab===t?' active':'');
      b.textContent = t;
      b.onclick = ()=>{ s.tab=t; render(); };
      el.appendChild(b);
    });
  }

  // ---- Helpers ----
  function addPerson(){
    s.people.push({ id: crypto.randomUUID(), name:'', club:'', klass:'', laps:[] });
    persist(); render();
  }
  function removePerson(idx){
    s.people.splice(idx,1);
    if (s.activeIndex >= s.people.length) s.activeIndex = 0;
    persist(); render();
  }

  // ---- START ----
  function renderStart(){
    const wrap = document.createElement('div');
    wrap.className = 'panel';
    wrap.innerHTML = `
      <div class="row">
        <div><label>Tävlingens namn</label><input id="name" placeholder="3GF Cup" value="${s.settings.name||''}"></div>
        <div><label>Datum</label><input id="date" type="date" value="${s.settings.date||''}"></div>
        <div><label>Plats</label><input id="place" placeholder="Sätila" value="${s.settings.place||''}"></div>
      </div>
      <div class="row">
        <div><label>Straff pistol (s/miss)</label><input id="penP" type="number" step="0.01" value="${s.settings.penP}"></div>
        <div><label>Straff hagel (s/miss)</label><input id="penH" type="number" step="0.01" value="${s.settings.penH}"></div>
        <div><label>Straff gevär (s/miss)</label><input id="penG" type="number" step="0.01" value="${s.settings.penG}"></div>
      </div>
      <div class="row">
        <div><label>Antal poängtavlor</label><input id="boards" type="number" min="1" max="12" value="${s.settings.boards}"></div>
        <div class="right"><label>&nbsp;</label><button id="startBtn">Starta tävling</button></div>
      </div>
      <hr>
      <div class="row">
        <div><label>Event-ID (lokal lagring)</label><input id="eventId" placeholder="satila-local" value="${s.eventId}"></div>
        <div class="right"><label>&nbsp;</label><button id="switchEvent">Byt Event-ID</button></div>
      </div>
    `;

    // Spara inställningar och gå till Tävling
    wrap.querySelector('#startBtn').onclick = ()=>{
      s.settings.name = qs('#name',wrap).value.trim();
      s.settings.date = qs('#date',wrap).value.trim();
      s.settings.place = qs('#place',wrap).value.trim();
      s.settings.penP = +qs('#penP',wrap).value || 0;
      s.settings.penH = +qs('#penH',wrap).value || 0;
      s.settings.penG = +qs('#penG',wrap).value || 0;
      s.settings.boards = Math.max(1, Math.min(12, +qs('#boards',wrap).value || 1));
      persist();
      s.tab = 'Tävling';
      render();
    };

    // Byt localStorage-nyckel (eventId) utan att blanda data
    wrap.querySelector('#switchEvent').onclick = ()=>{
      const id = qs('#eventId',wrap).value.trim() || 'satila-local';
      s.eventId = id;
      persist(); // skriv in under nya nyckeln
      render();
    };

    return wrap;
  }

  // ---- TÄVLING ----
  function renderCompetition(){
    const wrap = document.createElement('div');
    wrap.className = 'panel';

    // Poängtavlor
    const boards = document.createElement('div');
    boards.className = 'boards';
    for(let i=1;i<= (s.settings.boards||1);i++){
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = `Poängtavla ${i}`;
      boards.appendChild(chip);
    }
    wrap.appendChild(boards);

    // Deltagarväljare + varv-formulär
    const form = document.createElement('div');
    form.className = 'panel';
    form.innerHTML = `
      <div class="row">
        <div>
          <label>Välj deltagare</label>
          <select id="selPerson"></select>
        </div>
        <div class="right">
          <label>&nbsp;</label>
          <button id="addPersonBtn">Lägg till deltagare</button>
        </div>
      </div>
      <div class="row">
        <div><label>PT (poängtid)</label><input id="ptLap" type="number" step="0.01" value=""></div>
      </div>
      <div class="row">
        <div><label>Pistol tid</label><input id="tP" type="number" step="0.01" value=""></div>
        <div><label>Pistol miss</label><input id="mP" type="number" min="0" step="1" value=""></div>
        <div><label>Hagel tid</label><input id="tH" type="number" step="0.01" value=""></div>
        <div><label>Hagel miss</label><input id="mH" type="number" min="0" step="1" value=""></div>
        <div><label>Gevär tid</label><input id="tG" type="number" step="0.01" value=""></div>
        <div><label>Gevär miss</label><input id="mG" type="number" min="0" step="1" value=""></div>
      </div>
      <div class="row">
        <div class="right"><label>&nbsp;</label><button id="saveLap">Spara varv</button></div>
      </div>
    `;
    wrap.appendChild(form);

    // Lista deltagare (enkel)
    const ppl = document.createElement('div');
    ppl.className = 'people';
    s.people.forEach((p,idx)=>{
      const card = document.createElement('div');
      card.className = 'person';
      card.innerHTML = `
        <div class="row">
          <div><label>Namn</label><input data-f="name" value="${p.name||''}"></div>
          <div><label>Klubb</label><input data-f="club" value="${p.club||''}"></div>
          <div><label>Klass</label><input data-f="klass" value="${p.klass||''}"></div>
          <div class="right"><label>&nbsp;</label><button data-del="${idx}">Ta bort</button></div>
        </div>
        <div>
          <table>
            <thead><tr><th>#</th><th>PT</th><th class="num">P (t/m)</th><th class="num">H (t/m)</th><th class="num">G (t/m)</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      `;
      // bind inputs
      qsa('input', card).forEach(inp=>{
        inp.oninput = ()=>{
          const f = inp.getAttribute('data-f');
          p[f] = inp.value;
          persist();
        };
      });
      // ta bort
      qs(`button[data-del="${idx}"]`, card).onclick = ()=> removePerson(idx);

      // render laps (sort by dtH, FIX: b.dtH)
      const tb = card.querySelector('tbody');
      const laps = [...(p.laps||[])].sort((a,b)=>{
        if ((a.dtH||0)!==(b.dtH||0)) return (a.dtH||0) - (b.dtH||0); // FIX
        return 0;
      });
      laps.forEach((v,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${(v.pt||0).toFixed?.(2) ?? v.pt || 0}</td>
          <td class="num">${(v.tP||0)} / ${(v.mP||0)}</td>
          <td class="num">${(v.tH||0)} / ${(v.mH||0)}</td>
          <td class="num">${(v.tG||0)} / ${(v.mG||0)}</td>
        `;
        tb.appendChild(tr);
      });

      ppl.appendChild(card);
    });
    wrap.appendChild(ppl);

    // fyll select
    const sel = qs('#selPerson', form);
    sel.innerHTML = '';
    s.people.forEach((p,idx)=>{
      const opt = document.createElement('option');
      opt.value = String(idx);
      opt.textContent = p.name ? `${p.name} (${p.klass||'-'})` : `Deltagare ${idx+1}`;
      sel.appendChild(opt);
    });
    sel.value = String(s.activeIndex);

    // handlers
    qs('#addPersonBtn', form).onclick = addPerson;
    sel.onchange = ()=>{ s.activeIndex = +sel.value; persist(); };

    qs('#saveLap', form).onclick = ()=>{
      if (!s.people.length) { addPerson(); }
      const p = s.people[s.activeIndex] || s.people[0];
      const v = {
        tP:+$('#tP',form).value||0, mP:+$('#mP',form).value||0,
        tH:+$('#tH',form).value||0, mH:+$('#mH',form).value||0,
        tG:+$('#tG',form).value||0, mG:+$('#mG',form).value||0,
        pt:+$('#ptLap',form).value||0,
        dtH: Date.now()
      };
      (p.laps ||= []).push(v);

      // Töm inputs
      ['tP','mP','tH','mH','tG','mG','ptLap'].forEach(id=>$('#'+id,form).value='');

      // Hoppa till nästa deltagare (cirkulärt)
      if (s.people.length > 1) {
        s.activeIndex = (s.activeIndex + 1) % s.people.length;
      }
      persist();
      render(); // återskapa vyn med uppdaterad aktiv
    };

    return wrap;
  }

  // ---- Render root ----
  function render(){
    renderTabs();
    const v = document.getElementById('view');
    v.innerHTML = '';
    if (s.tab==='Start') v.appendChild(renderStart());
    if (s.tab==='Tävling') v.appendChild(renderCompetition());
  }

  // ---- Init ----
  load('satila-local');
  render();
})();
</script>
</body>
</html>
