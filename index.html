<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>3GF – v8 Supabase</title>
<style>
  :root{ --bg:#0e1117; --panel:#151a23; --panel2:#10141d; --border:#283043; --ink:#e7ebf4; --muted:#a5b0c4; }
  body{ font-family:system-ui, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:10px; }
  h1{ font-size:1.2rem; margin:0 0 8px; }
  .tabs{ display:flex; gap:8px; margin-bottom:10px; }
  .tab{ padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:var(--panel2); cursor:pointer; }
  .tab.active{ background:#1e2a44; font-weight:700; }
  .panel{ background:var(--panel); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:12px; }
  label{ display:block; margin-top:8px; font-size:.95rem; }
  input, select, button{ width:100%; padding:10px; margin-top:4px; border-radius:8px; border:1px solid var(--border); background:var(--panel2); color:var(--ink); font-size:1rem; }
  button{ cursor:pointer; font-weight:700; }
  .btn-primary{ background:#1e2a44; }
  .row{ display:flex; gap:10px; flex-wrap:wrap; }
  .row > div{ flex:1; min-width:140px; }
  .active-badge{ font-weight:700; background:#1e2a44; padding:6px 10px; border-radius:8px; margin-bottom:10px; display:inline-block; }
  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ border-bottom:1px solid var(--border); padding:6px; text-align:left; }
  th{ background:var(--panel2); }
  .hidden{ display:none !important; }
  .meta{ color:var(--muted); font-size:.9rem; }
  .lapItem{ border:1px dashed var(--border); border-radius:8px; padding:8px; margin:6px 0; background:var(--panel2); }
  .lapActions{ display:flex; gap:6px; }
</style>
</head>
<body>
<h1>3GF – v8 (Säker, via server-API)</h1>

<div class="tabs">
  <div class="tab active" id="tabStart">Start</div>
  <div class="tab" id="tabComp">Tävling</div>
</div>

<!-- START -->
<div id="viewStart">
  <div class="panel">
    <h3>Grundinställningar</h3>
    <div class="row">
      <div><label>Miss-straff Pistol (s)</label><input id="penP" type="number" step="0.01" value="5"></div>
      <div><label>Miss-straff Hagel (s)</label><input id="penH" type="number" step="0.01" value="5"></div>
      <div><label>Miss-straff Karbin (s)</label><input id="penG" type="number" step="0.01" value="5"></div>
    </div>
    <div class="row">
      <div><label>Tävlingsnamn</label><input id="evName" type="text" placeholder="t.ex. Sätila 3GF Cup"></div>
      <div><label>Datum</label><input id="evDate" type="date"></div>
      <div><label>Plats</label><input id="evPlace" type="text" placeholder="t.ex. Sätila"></div>
    </div>
    <div class="row">
      <button id="saveSettings" class="btn-primary">Spara inställningar (lokalt)</button>
    </div>
    <div class="meta" id="settingsSavedMsg"></div>
  </div>

  <div class="panel">
    <h3>Server (Spara/Ladda till DB)</h3>
    <div class="row">
      <div><label>Event-ID</label><input id="eventId" placeholder="satila-2025-09-14"></div>
      <div><label>Admin-PIN (för spara)</label><input id="adminPin" placeholder="(din hemliga PIN)"></div>
    </div>
    <div class="row">
      <button id="btnLoadServer">Ladda från server</button>
      <button id="btnSaveServer" class="btn-primary">Spara till server</button>
    </div>
    <div class="meta">POST kräver korrekt Admin-PIN (jämförs mot serverns <code>ADMIN_TOKEN</code>).</div>
  </div>
</div>

<!-- COMPETITION -->
<div id="viewComp" class="hidden">
  <div class="panel">
    <h3>Lägg till deltagare</h3>
    <div class="row">
      <div><label>Namn</label><input id="name" type="text" /></div>
      <div><label>Klubb</label><input id="club" type="text" /></div>
      <div><label>Klass</label><input id="klass" type="text" /></div>
    </div>
    <button id="addParticipant" class="btn-primary">Lägg till</button>
  </div>

  <div class="panel">
    <label>Aktiv deltagare</label>
    <select id="active"></select>
    <div id="activeBadge" class="active-badge">Ingen vald</div>

    <div class="row">
      <div><label>Pistol tid</label><input id="tP" type="number" step="0.01" /></div>
      <div><label>Miss P</label><input id="mP" type="number" /></div>
    </div>
    <div class="row">
      <div><label>Hagel tid</label><input id="tH" type="number" step="0.01" /></div>
      <div><label>Miss H</label><input id="mH" type="number" /></div>
    </div>
    <div class="row">
      <div><label>Karbin tid</label><input id="tG" type="number" step="0.01" /></div>
      <div><label>Miss K</label><input id="mG" type="number" /></div>
    </div>
    <div><label>PT detta varv (sek, minus)</label><input id="ptLap" type="number" step="0.01" /></div>

    <div class="row">
      <button id="saveLap" class="btn-primary">Spara varv</button>
    </div>

    <div id="lapsList"></div>
  </div>

  <div class="panel">
    <h3>Resultat</h3>
    <div class="row" style="gap:6px; margin-bottom:8px;">
      <button id="exportCSV" class="btn-primary">Exportera CSV</button>
      <button id="exportHTML" class="btn-primary">Snygg utskrift / Export</button>
    </div>
    <div id="resultsContainer"></div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const s = {
    settings:{penP:2,penH:2,penG:2, evName:"", evDate:"", evPlace:""},
    eventId:"",
    adminPin:"",
    people:[],  // {id,name,club,klass,laps:[{tP,mP,tH,mH,tG,mG,pt}], sum:{}}
    activeIndex:-1
  };

  // Tabs
  const showStart=()=>{ tab("Start"); $("viewStart").classList.remove("hidden"); $("viewComp").classList.add("hidden"); };
  const showComp =()=>{ tab("Comp");  $("viewComp").classList.remove("hidden");  $("viewStart").classList.add("hidden"); };
  const tab = w => { $("tabStart").classList.toggle("active", w==="Start"); $("tabComp").classList.toggle("active", w==="Comp"); };
  $("tabStart").addEventListener("click", showStart);
  $("tabComp").addEventListener("click", showComp);

  // Helpers
  const to2 = x => (Math.round(x*100)/100).toFixed(2);
  function recalc(p){
    let dtP=0,dtH=0,dtG=0,pt=0;
    for(const v of p.laps){
      dtP+=(v.tP||0)+(v.mP||0)*s.settings.penP;
      dtH+=(v.tH||0)+(v.mH||0)*s.settings.penH;
      dtG+=(v.tG||0)+(v.mG||0)*s.settings.penG;
      pt +=(v.pt||0);
    }
    p.sum={ dtP, dtH, dtG, pt, tt: dtP+dtH+dtG-pt };
  }
  function sortPeople(list){
    list.forEach(recalc);
    list.sort((a,b)=>{
      if(a.sum.tt!==b.sum.tt) return a.sum.tt-b.sum.tt;
      if(a.sum.dtP!==b.sum.dtP) return a.sum.dtP-b.sum.dtP;
      if(a.sum.dtH!==b.sum.dtH) return a.sum.dtH-b.sum.dtH;
      if(a.sum.dtG!==b.sum.dtG) return a.sum.dtG-b.sum.dtG;
      return a.name.localeCompare(b.name);
    });
  }
  function refreshActive(){
    $("active").innerHTML = s.people.map((p,i)=>`<option value="${i}">${p.name}</option>`).join("");
    if(s.people.length){ if(s.activeIndex<0) s.activeIndex=0; $("active").value=s.activeIndex; }
  }

  // Settings
  function saveSettingsLocal(){
    s.settings.penP = +$("penP").value || 0;
    s.settings.penH = +$("penH").value || 0;
    s.settings.penG = +$("penG").value || 0;
    s.settings.evName = $("evName").value.trim();
    s.settings.evDate = $("evDate").value;
    s.settings.evPlace= $("evPlace").value.trim();
    s.eventId = $("eventId").value.trim();
    s.adminPin = $("adminPin").value.trim(); // används bara för POST
    try{ localStorage.setItem("gf_v8_secure", JSON.stringify(s)); }catch(e){}
    $("settingsSavedMsg").textContent="Sparat lokalt."; setTimeout(()=>$("settingsSavedMsg").textContent="",1200);
  }
  $("saveSettings").addEventListener("click", saveSettingsLocal);

  // Participants
  $("addParticipant").addEventListener("click", ()=>{
    const name=$("name").value.trim(); if(!name) return;
    const p={ id:crypto.randomUUID(), name, club:$("club").value.trim(), klass:$("klass").value.trim(), laps:[], sum:{} };
    s.people.push(p); s.activeIndex=s.people.length-1;
    ["name","club","klass"].forEach(id=>$(id).value="");
    refreshActive(); render(); persistLocal();
  });
  $("active").addEventListener("change", ()=>{ s.activeIndex=parseInt($("active").value,10); render(); });

  // Laps
  $("saveLap").addEventListener("click", ()=>{
    if(s.activeIndex<0) return;
    const v={ tP:+$("tP").value||0, mP:+$("mP").value||0, tH:+$("tH").value||0, mH:+$("mH").value||0, tG:+$("tG").value||0, mG:+$("mG").value||0, pt:+$("ptLap").value||0 };
    if(Object.values(v).every(x=>x===0)) return; // skydd mot dubbeltryck
    s.people[s.activeIndex].laps.push(v);
    ["tP","mP","tH","mH","tG","mG","ptLap"].forEach(id=>$(id).value="");
    render(); persistLocal();
  });

  function renderLapList(){
    const box=$("lapsList"); box.innerHTML="";
    const p=s.people[s.activeIndex]; if(!p){ $("activeBadge").textContent="Ingen vald"; return; }
    $("activeBadge").textContent="Aktiv: "+p.name;
    p.laps.forEach((v,i)=>{
      const dtP=(v.tP||0)+(v.mP||0)*s.settings.penP, dtH=(v.tH||0)+(v.mH||0)*s.settings.penH, dtG=(v.tG||0)+(v.mG||0)*s.settings.penG, tt=dtP+dtH+dtG-(v.pt||0);
      const div=document.createElement("div"); div.className="lapItem";
      div.innerHTML=`<div><b>Varv ${i+1}</b> – P: ${to2(dtP)} H: ${to2(dtH)} K: ${to2(dtG)} | PT: ${to2(v.pt||0)} | TT: <b>${to2(tt)}</b></div>
        <div class="lapActions"><button data-edit="${i}">Redigera</button><button data-del="${i}">Ta bort</button></div>`;
      div.querySelector('[data-edit]').onclick=()=>{
        $("tP").value=v.tP||0; $("mP").value=v.mP||0; $("tH").value=v.tH||0; $("mH").value=v.mH||0; $("tG").value=v.tG||0; $("mG").value=v.mG||0; $("ptLap").value=v.pt||0;
        const handler=()=>{
          const nv={ tP:+$("tP").value||0, mP:+$("mP").value||0, tH:+$("tH").value||0, mH:+$("mH").value||0, tG:+$("tG").value||0, mG:+$("mG").value||0, pt:+$("ptLap").value||0 };
          if(Object.values(nv).every(x=>x===0)){ cleanup(); return; }
          p.laps[i]=nv; ["tP","mP","tH","mH","tG","mG","ptLap"].forEach(id=>$(id).value=""); cleanup(); render(); persistLocal();
        };
        const cleanup=()=>{ $("saveLap").removeEventListener("click", handler); $("saveLap").textContent="Spara varv"; };
        cleanup(); $("saveLap").addEventListener("click", handler); $("saveLap").textContent="Spara ändring";
      };
      div.querySelector('[data-del]').onclick=()=>{ p.laps.splice(i,1); render(); persistLocal(); };
      box.appendChild(div);
    });
  }

  function render(){
    refreshActive(); renderLapList();
    const cont=$("resultsContainer"); cont.innerHTML="";
    if(!s.people.length){ cont.innerHTML='<div class="meta">Inga deltagare ännu.</div>'; return; }
    const list=s.people.slice(); sortPeople(list);
    let html="<h4>Totalresultat</h4><table><thead><tr><th>#</th><th>Namn</th><th>Klass</th><th>ΣDT P</th><th>ΣDT H</th><th>ΣDT K</th><th>ΣPT</th><th>TT</th></tr></thead><tbody>";
    list.forEach((p,i)=>{ html+=`<tr><td>${i+1}</td><td>${p.name}</td><td>${p.klass||""}</td><td>${to2(p.sum.dtP)}</td><td>${to2(p.sum.dtH)}</td><td>${to2(p.sum.dtG)}</td><td>${to2(p.sum.pt)}</td><td><b>${to2(p.sum.tt)}</b></td></tr>`; });
    html+="</tbody></table>";
    const maxLaps=Math.max(...s.people.map(p=>p.laps.length));
    for(let v=0; v<maxLaps; v++){
      const lapList=s.people.filter(p=>p.laps[v]).map(p=>{
        const x=p.laps[v], dtP=(x.tP||0)+(x.mP||0)*s.settings.penP, dtH=(x.tH||0)+(x.mH||0)*s.settings.penH, dtG=(x.tG||0)+(x.mG||0)*s.settings.penG;
        return { name:p.name, klass:p.klass||"", dtP, dtH, dtG, pt:x.pt||0, tt:dtP+dtH+dtG-(x.pt||0) };
      }).sort((a,b)=>{
        if(a.tt!==b.tt) return a.tt-b.tt;
        if(a.dtP!==b.dtP) return a.dtP-b.dtP;
        if(a.dtH!==b.dtH) return a.dtH-b.dtH;
        if(a.dtG!==b.dtG) return a.dtG-b.dtG;
        return a.name.localeCompare(b.name);
      });
      html+=`<h4>Varv ${v+1}</h4><table><thead><tr><th>#</th><th>Namn</th><th>Klass</th><th>DT P</th><th>DT H</th><th>DT K</th><th>PT</th><th>TT</th></tr></thead><tbody>`;
      lapList.forEach((r,i)=>{ html+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.klass}</td><td>${to2(r.dtP)}</td><td>${to2(r.dtH)}</td><td>${to2(r.dtG)}</td><td>${to2(r.pt)}</td><td><b>${to2(r.tt)}</b></td></tr>`; });
      html+="</tbody></table>";
    }
    cont.innerHTML=html;
  }

  // Export
  $("exportCSV").addEventListener("click", ()=>{
    const list=s.people.slice(); sortPeople(list);
    let csv=`Resultatlista – 3GF;${s.settings.evName||""};${s.settings.evDate||""};${s.settings.evPlace||""}\n`;
    csv+="Placering;Namn;Klass;ΣDT P;ΣDT H;ΣDT K;ΣPT;TT\n";
    list.forEach((p,i)=>{ csv+=`${i+1};${p.name};${p.klass||""};${to2(p.sum.dtP)};${to2(p.sum.dtH)};${to2(p.sum.dtG)};${to2(p.sum.pt)};${to2(p.sum.tt)}\n`; });
    const maxLaps=Math.max(...s.people.map(p=>p.laps.length));
    for(let v=0; v<maxLaps; v++){
      csv+=`\nVarv ${v+1}\nPlacering;Namn;Klass;DT P;DT H;DT K;PT;TT\n`;
      const lapList=s.people.filter(p=>p.laps[v]).map(p=>{
        const x=p.laps[v], dtP=(x.tP||0)+(x.mP||0)*s.settings.penP, dtH=(x.tH||0)+(x.mH||0)*s.settings.penH, dtG=(x.tG||0)+(x.mG||0)*s.settings.penG;
        return { name:p.name, klass:p.klass||"", dtP, dtH, dtG, pt:x.pt||0, tt:dtP+dtH+dtG-(x.pt||0) };
      }).sort((a,b)=>a.tt-b.tt);
      lapList.forEach((r,i)=>{ csv+=`${i+1};${r.name};${r.klass};${to2(r.dtP)};${to2(r.dtH)};${to2(r.dtG)};${to2(r.pt)};${to2(r.tt)}\n`; });
    }
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="resultat.csv"; a.click();
  });

  $("exportHTML").addEventListener("click", ()=>{
    const list=s.people.slice(); sortPeople(list);
    let html = `<!doctype html><html lang="sv"><meta charset="utf-8"><title>Resultat</title>
    <style>body{font-family:sans-serif;margin:20px;}table{border-collapse:collapse;width:100%;margin-bottom:20px;}
    th,td{border:1px solid #ccc;padding:6px;text-align:left;}th{background:#eee;}</style><body>`;
    html+=`<h1>Resultatlista – 3GF</h1><div><b>${s.settings.evName||""}</b> – ${s.settings.evDate||""} – ${s.settings.evPlace||""}</div>`;
    html+=`<h2>Totalresultat</h2><table><thead><tr><th>#</th><th>Namn</th><th>Klass</th><th>ΣDT P</th><th>ΣDT H</th><th>ΣDT K</th><th>ΣPT</th><th>TT</th></tr></thead><tbody>`;
    list.forEach((p,i)=>{ html+=`<tr><td>${i+1}</td><td>${p.name}</td><td>${p.klass||""}</td><td>${to2(p.sum.dtP)}</td><td>${to2(p.sum.dtH)}</td><td>${to2(p.sum.dtG)}</td><td>${to2(p.sum.pt)}</td><td><b>${to2(p.sum.tt)}</b></td></tr>`; });
    html+="</tbody></table>";
    const maxLaps=Math.max(...s.people.map(p=>p.laps.length));
    for(let v=0; v<maxLaps; v++){
      html+=`<h2>Varv ${v+1}</h2><table><thead><tr><th>#</th><th>Namn</th><th>Klass</th><th>DT P</th><th>DT H</th><th>DT K</th><th>PT</th><th>TT</th></tr></thead><tbody>`;
      const lapList=s.people.filter(p=>p.laps[v]).map(p=>{
        const x=p.laps[v], dtP=(x.tP||0)+(x.mP||0)*s.settings.penP, dtH=(x.tH||0)+(x.mH||0)*s.settings.penH, dtG=(x.tG||0)+(x.mG||0)*s.settings.penG;
        return { name:p.name, klass:p.klass||"", dtP, dtH, dtG, pt:x.pt||0, tt:dtP+dtH+dtG-(x.pt||0) };
      }).sort((a,b)=>a.tt-b.tt);
      lapList.forEach((r,i)=>{ html+=`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.klass}</td><td>${to2(r.dtP)}</td><td>${to2(r.dtH)}</td><td>${to2(r.dtG)}</td><td>${to2(r.pt)}</td><td><b>${to2(r.tt)}</b></td></tr>`; });
      html+="</tbody></table>";
    }
    html += "</body></html>";
    const w=window.open(""); w.document.write(html); w.document.close();
  });

  // Server SAVE / LOAD
  $("btnSaveServer").addEventListener("click", async ()=>{
    saveSettingsLocal();
    if(!s.eventId){ alert("Sätt Event-ID under Start."); return; }
    const payload = {
      event: { id:s.eventId, name:s.settings.evName, date:s.settings.evDate, place:s.settings.evPlace,
               penP:s.settings.penP, penH:s.settings.penH, penG:s.settings.penG },
      people: s.people
    };
    const res = await fetch(`/api/event?id=${encodeURIComponent(s.eventId)}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", "x-admin-token": s.adminPin || "" },
      body: JSON.stringify(payload)
    });
    if(!res.ok){ const t=await res.text().catch(()=> ""); alert("Kunde inte spara till server: " + t); return; }
    alert("Sparat till server.");
  });

  $("btnLoadServer").addEventListener("click", async ()=>{
    saveSettingsLocal();
    if(!s.eventId){ alert("Sätt Event-ID under Start."); return; }
    const res = await fetch(`/api/event?id=${encodeURIComponent(s.eventId)}`);
    if(!res.ok){ const t=await res.text().catch(()=> ""); alert("Kunde inte ladda från server: " + t); return; }
    const data = await res.json();
    if(data.event){
      s.settings.evName=data.event.name||""; s.settings.evDate=data.event.date||""; s.settings.evPlace=data.event.place||"";
      s.settings.penP=+data.event.pen_p||2; s.settings.penH=+data.event.pen_h||2; s.settings.penG=+data.event.pen_g||2;
      $("evName").value=s.settings.evName; $("evDate").value=s.settings.evDate; $("evPlace").value=s.settings.evPlace;
      $("penP").value=s.settings.penP; $("penH").value=s.settings.penH; $("penG").value=s.settings.penG;
    } else {
      // Nollställ om event saknas
      s.settings.evName=""; s.settings.evDate=""; s.settings.evPlace="";
      $("evName").value=""; $("evDate").value=""; $("evPlace").value="";
    }
    s.people = (data.people||[]).map(r=>({ id:r.external_id, name:r.name, club:r.club||"", klass:r.klass||"", laps:r.laps||[], sum:{} }));
    s.activeIndex = s.people.length ? 0 : -1;
    showComp(); render(); persistLocal();
  });

  // Local persistence
  function persistLocal(){ try{ localStorage.setItem("gf_v8_secure", JSON.stringify(s)); }catch(e){} }
  (function restore(){
    try{
      const raw=localStorage.getItem("gf_v8_secure"); if(!raw) return;
      const b=JSON.parse(raw);
      s.settings=b.settings||s.settings;
      s.people=b.people||[];
      s.eventId=b.eventId||"";
      s.adminPin=b.adminPin||"";
      s.activeIndex=typeof b.activeIndex==="number" ? b.activeIndex : -1;
      $("penP").value=s.settings.penP; $("penH").value=s.settings.penH; $("penG").value=s.settings.penG;
      $("evName").value=s.settings.evName||""; $("evDate").value=s.settings.evDate||""; $("evPlace").value=s.settings.evPlace||"";
      $("eventId").value=s.eventId||""; $("adminPin").value=s.adminPin||"";
    }catch(e){}
    if(s.people.length){ showComp(); }
    render();
  })();
})();
</script>
</body>
</html>
