<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3GF – Tävling</title>
  <style>
    :root{ --bg:#0e1117; --panel:#151a23; --panel2:#10141d; --border:#283043; --ink:#e7ebf4; --muted:#a5b0c4; }
    *{ box-sizing:border-box; }
    body{ font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); margin:0; padding:12px; }
    h1{ font-size:1.2rem; margin:0 0 10px; }
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tab{ padding:10px 14px; background:var(--panel); border:1px solid var(--border); border-radius:10px; cursor:pointer; }
    .tab.active{ outline:2px solid #3b82f6; }
    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; margin-bottom:12px; }
    label{ display:block; margin:8px 0 4px; color:var(--muted); }
    input, select, button{ width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:var(--panel2); color:var(--ink); }
    button{ cursor:pointer; font-weight:600; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row>div{ flex:1; min-width:200px; }
    .right{ text-align:right; }
    .boards{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--panel2); }
    table{ width:100%; border-collapse:collapse; margin-top:8px; }
    th, td{ border-bottom:1px solid #283043; padding:8px; text-align:left; }
    .num{ text-align:right; }

    /* Varvform: tid stor, miss halvbred */
    .pair{ display:flex; gap:10px; }
    .time{ flex:2; }
    .miss{ flex:1; }
  </style>
</head>
<body>
  <h1>3GF – Tävling</h1>
  <div class="tabs" id="tabs"></div>
  <div id="view"></div>

<script>
(function(){
  const $  = (id, el=document) => el.getElementById(id);
  const qs = (sel, el=document) => el.querySelector(sel);
  const qsa= (sel, el=document) => Array.from(el.querySelectorAll(sel));
  const SKEY = id => `3gf_state_${id||'local'}`;

  // ---- App state (DB-agnostiskt) ----
  let s = {
    tab: 'Start',
    eventId: 'satila-local',
    settings: { name:'', date:'', place:'', penP:5, penH:5, penG:5, boards:3 },
    people: [],
    activeId: null // <— stabil ID istället för index
  };

  // ---- Persist ----
  function persist(){ localStorage.setItem(SKEY(s.eventId), JSON.stringify(s)); }
  function load(id){
    const raw = localStorage.getItem(SKEY(id));
    if (raw) { try { s = JSON.parse(raw); } catch(_){ } }
    s.eventId = id;
    // Tvinga Start som första sida om inget igång
    if (!s.settings || (!s.settings.name && !(s.people&&s.people.length))) s.tab = 'Start';
    // Säkerställ aktivt ID
    if (s.people.length){
      if (!s.activeId || !s.people.find(p=>p.id===s.activeId)) s.activeId = s.people[0].id;
    } else {
      s.activeId = null;
    }
  }

  // ---- Tabs ----
  const TABS = ['Start','Tävling'];
  function renderTabs(){
    const el = $('tabs'); el.innerHTML='';
    TABS.forEach(t=>{
      const b = document.createElement('button');
      b.className = 'tab' + (s.tab===t?' active':'');
      b.textContent = t;
      b.onclick = ()=>{ s.tab=t; render(); };
      el.appendChild(b);
    });
  }

  // ---- Helpers ----
  const uid = () => (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
  const getPerson = (id)=> s.people.find(p=>p.id===id) || null;
  const personLabel = (p, idx) => {
    const nm = (p.name||'').trim();
    const kl = (p.klass||'').trim();
    return nm ? `${nm}${kl ? ` (${kl})` : ''}` : `Deltagare ${idx+1}`;
  };

  function addPerson(){
    const id = uid();
    const idx = s.people.length;
    s.people.push({ id, name:'', club:'', klass:'', laps:[] });
    s.activeId = id; // välj direkt den nya
    persist(); render();
  }
  function removePerson(id){
    const i = s.people.findIndex(p=>p.id===id);
    if (i>=0) s.people.splice(i,1);
    if (s.people.length){
      s.activeId = s.people[Math.min(i, s.people.length-1)].id;
    } else {
      s.activeId = null;
    }
    persist(); render();
  }

  // ---- START ----
  function renderStart(){
    const wrap = document.createElement('div');
    wrap.className = 'panel';
    wrap.innerHTML = `
      <div class="row">
        <div><label>Tävlingens namn</label><input id="name" placeholder="3GF Cup" value="${s.settings.name||''}"></div>
        <div><label>Datum</label><input id="date" type="date" value="${s.settings.date||''}"></div>
        <div><label>Plats</label><input id="place" placeholder="Sätila" value="${s.settings.place||''}"></div>
      </div>
      <div class="row">
        <div><label>Straff pistol (s/miss)</label><input id="penP" type="number" step="0.01" value="${s.settings.penP}"></div>
        <div><label>Straff hagel (s/miss)</label><input id="penH" type="number" step="0.01" value="${s.settings.penH}"></div>
        <div><label>Straff gevär (s/miss)</label><input id="penG" type="number" step="0.01" value="${s.settings.penG}"></div>
      </div>
      <div class="row">
        <div><label>Antal poängtavlor</label><input id="boards" type="number" min="1" max="12" value="${s.settings.boards}"></div>
        <div class="right"><label>&nbsp;</label><button id="startBtn">Starta tävling</button></div>
      </div>
      <hr>
      <div class="row">
        <div><label>Event-ID (lokal lagring)</label><input id="eventId" placeholder="satila-local" value="${s.eventId}"></div>
        <div class="right"><label>&nbsp;</label><button id="switchEvent">Byt Event-ID</button></div>
      </div>
    `;

    qs('#startBtn',wrap).onclick = ()=>{
      s.settings.name = qs('#name',wrap).value.trim();
      s.settings.date = qs('#date',wrap).value.trim();
      s.settings.place = qs('#place',wrap).value.trim();
      s.settings.penP = +qs('#penP',wrap).value || 0;
      s.settings.penH = +qs('#penH',wrap).value || 0;
      s.settings.penG = +qs('#penG',wrap).value || 0;
      s.settings.boards = Math.max(1, Math.min(12, +qs('#boards',wrap).value || 1));
      persist();
      if (!s.people.length) { addPerson(); } // se till att något är valt
      s.tab = 'Tävling';
      render();
    };

    qs('#switchEvent',wrap).onclick = ()=>{
      const id = qs('#eventId',wrap).value.trim() || 'satila-local';
      s.eventId = id; persist(); render();
    };

    return wrap;
  }

  // ---- Summering ----
  function computeSummary(){
    const penP = s.settings.penP, penH = s.settings.penH, penG = s.settings.penG;
    return s.people.map((p,idx)=>{
      let base=0, miss=0, laps=0;
      (p.laps||[]).forEach(v=>{
        base += (v.tP||0)+(v.tH||0)+(v.tG||0)+(v.pt||0);
        miss += (v.mP||0)*penP + (v.mH||0)*penH + (v.mG||0)*penG;
        laps++;
      });
      return { name: personLabel(p, idx), club:p.club||'', klass:p.klass||'', laps, total: base+miss };
    }).sort((a,b)=>a.total-b.total);
  }

  // ---- TÄVLING ----
  function renderCompetition(){
    const wrap = document.createElement('div');
    wrap.className = 'panel';

    // Överdel: välj deltagare, lägg till/ta bort
    const head = document.createElement('div');
    head.className = 'row';
    head.innerHTML = `
      <div>
        <label>Välj deltagare</label>
        <select id="selPerson"></select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="addPersonBtn">Lägg till deltagare</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="removePersonBtn">Ta bort vald</button>
      </div>
    `;
    wrap.appendChild(head);

    const sel = qs('#selPerson', head);
    sel.innerHTML = '';
    s.people.forEach((p,idx)=>{
      const opt = document.createElement('option');
      opt.value = p.id; // <— värde = stabilt ID
      opt.textContent = personLabel(p, idx);
      sel.appendChild(opt);
    });
    if (s.activeId) sel.value = s.activeId;

    qs('#addPersonBtn', head).onclick = addPerson;
    qs('#removePersonBtn', head).onclick = ()=>{ if (s.activeId) removePerson(s.activeId); };
    sel.onchange = ()=>{ s.activeId = sel.value || null; persist(); render(); };

    const p = s.activeId ? getPerson(s.activeId) : null;

    // Formulär för vald deltagare
    const form = document.createElement('div');
    form.className = 'panel';
    form.innerHTML = `
      <div class="row">
        <div><label>Namn</label><input id="p_name" value="${p?.name||''}"></div>
        <div><label>Klubb</label><input id="p_club" value="${p?.club||''}"></div>
        <div><label>Klass</label><input id="p_klass" value="${p?.klass||''}"></div>
      </div>

      <div class="row">
        <div><label>PT (poängtid)</label><input id="ptLap" type="number" step="0.01" value=""></div>
      </div>

      <div class="row">
        <div class="pair time"><div><label>Pistol tid</label><input id="tP" type="number" step="0.01" value=""></div></div>
        <div class="pair miss"><div><label>Pistol miss</label><input id="mP" type="number" min="0" step="1" value=""></div></div>
      </div>
      <div class="row">
        <div class="pair time"><div><label>Hagel tid</label><input id="tH" type="number" step="0.01" value=""></div></div>
        <div class="pair miss"><div><label>Hagel miss</label><input id="mH" type="number" min="0" step="1" value=""></div></div>
      </div>
      <div class="row">
        <div class="pair time"><div><label>Gevär tid</label><input id="tG" type="number" step="0.01" value=""></div></div>
        <div class="pair miss"><div><label>Gevär miss</label><input id="mG" type="number" min="0" step="1" value=""></div></div>
      </div>

      <div class="row">
        <div class="right"><label>&nbsp;</label><button id="saveLap">Spara varv</button></div>
      </div>
    `;
    wrap.appendChild(form);

    // Bind personfält (uppdatera bara option-texten för den aktiva)
    if (p){
      const updateOptText = ()=>{
        const opt = qsa('option', sel).find(o=>o.value===p.id);
        if (!opt) return;
        const idx = s.people.findIndex(x=>x.id===p.id);
        opt.textContent = personLabel(p, Math.max(0, idx));
      };
      qs('#p_name',form).oninput = e=>{ p.name = e.target.value; persist(); updateOptText(); };
      qs('#p_club',form).oninput = e=>{ p.club = e.target.value; persist(); };
      qs('#p_klass',form).oninput= e=>{ p.klass= e.target.value; persist(); updateOptText(); };
    }

    // Lista varv för vald deltagare
    const lapsWrap = document.createElement('div');
    lapsWrap.className = 'panel';
    lapsWrap.innerHTML = `<h3 style="margin:0 0 8px">Varv – ${p ? (p.name || personLabel(p, s.people.findIndex(x=>x.id===p.id))) : 'Ingen vald'}</h3>
      <table><thead><tr>
        <th>#</th><th>PT</th><th class="num">P (t/m)</th><th class="num">H (t/m)</th><th class="num">G (t/m)</th>
      </tr></thead><tbody></tbody></table>`;
    const tb = lapsWrap.querySelector('tbody');
    if (p){
      const laps = [...(p.laps||[])].sort((a,b)=>{
        if ((a.dtH||0)!==(b.dtH||0)) return (a.dtH||0)-(b.dtH||0); // FIX: b.dtH
        return 0;
      });
      laps.forEach((v,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${(v.pt||0).toFixed ? (v.pt||0).toFixed(2) : (v.pt||0)}</td>
          <td class="num">${(v.tP||0)} / ${(v.mP||0)}</td>
          <td class="num">${(v.tH||0)} / ${(v.mH||0)}</td>
          <td class="num">${(v.tG||0)} / ${(v.mG||0)}</td>`;
        tb.appendChild(tr);
      });
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5">Lägg till en deltagare för att börja.</td>`;
      tb.appendChild(tr);
    }
    wrap.appendChild(lapsWrap);

    // Spara varv
    qs('#saveLap', form).onclick = ()=>{
      if (!s.activeId){
        addPerson();
      }
      const p2 = getPerson(s.activeId);
      if (!p2) return;

      const v = {
        tP:+qs('#tP',form).value||0, mP:+qs('#mP',form).value||0,
        tH:+qs('#tH',form).value||0, mH:+qs('#mH',form).value||0,
        tG:+qs('#tG',form).value||0, mG:+qs('#mG',form).value||0,
        pt:+qs('#ptLap',form).value||0,
        dtH: Date.now()
      };
      (p2.laps ||= []).push(v);

      // Rensa inputs
      ['#tP','#mP','#tH','#mH','#tG','#mG','#ptLap'].forEach(sel=>{ const el=qs(sel,form); if(el) el.value=''; });

      // Nästa deltagare via ID
      if (s.people.length>1){
        const i = s.people.findIndex(x=>x.id===s.activeId);
        const next = s.people[(i+1)%s.people.length];
        s.activeId = next.id;
      }
      persist(); render();
    };

    // Resultatsammanfattning
    const sum = computeSummary();
    const res = document.createElement('div');
    res.className = 'panel';
    res.innerHTML = `<h3 style="margin:0 0 8px">Resultat (totaltid inkl. straff)</h3>
      <table><thead><tr><th>Namn</th><th>Klubb</th><th>Klass</th><th class="num">Varv</th><th class="num">Total (s)</th></tr></thead><tbody></tbody></table>`;
    const rtb = res.querySelector('tbody');
    sum.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.name}</td><td>${r.club}</td><td>${r.klass}</td><td class="num">${r.laps}</td><td class="num">${r.total.toFixed(2)}</td>`;
      rtb.appendChild(tr);
    });
    wrap.appendChild(res);

    // Poängtavlor visas SIST (efter allt annat)
    const boards = document.createElement('div');
    boards.className = 'boards';
    for(let i=1;i<= (s.settings.boards||1);i++){
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.textContent = `Poängtavla ${i}`;
      boards.appendChild(chip);
    }
    wrap.appendChild(boards);

    return wrap;
  }

  // ---- Render root ----
  function render(){
    renderTabs();
    const v = $('view'); v.innerHTML='';
    if (s.tab==='Start') v.appendChild(renderStart());
    if (s.tab==='Tävling') v.appendChild(renderCompetition());
  }

  // ---- Init ----
  load('satila-local');
  render();
})();
</script>
</body>
</html>
